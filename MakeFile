# -------------------------
# CV_tailorer Makefile
# -------------------------

UV := uv
INPUT_DIR := input_files
OUTPUT_DIR := output_files
PYPROJECT := pyproject.toml
LOCKFILE := requirements.lock

# OS detection
ifeq ($(OS),Windows_NT)
    RM_FILE = del /Q
    RM_DIR = rmdir /S /Q
else
    RM_FILE = rm -f
    RM_DIR = rm -rf
endif

.PHONY: help lock install sync generate cleanup reset precommit precommit-check check-dirs

# -------------------------
# Help
# -------------------------
help:
	@echo Available targets:
	@echo "  make lock             - Generate dependency lockfile"
	@echo "  make install          - Install dependencies from lockfile"
	@echo "  make sync             - Synchronize environment with lockfile"
	@echo "  make generate         - Run the generator script"
	@echo "  make cleanup          - Remove input/output files (safe)"
	@echo "  make reset            - Delete environment + reinstall dependencies"
	@echo "  make precommit        - Install pre-commit Git hooks"
	@echo "  make precommit-check  - Run all pre-commit hooks on all files"

# -------------------------
# Dependency Locking
# -------------------------
lock:
	@echo "Generating dependency lockfile..."
	$(UV) pip compile $(PYPROJECT) -o $(LOCKFILE)

# -------------------------
# Install Dependencies
# -------------------------
install: $(LOCKFILE)
	@echo "Installing dependencies from lockfile..."
	$(UV) pip install -r $(LOCKFILE)

# -------------------------
# Synchronize Environment
# -------------------------
sync:
	@echo "Synchronizing environment to lockfile..."
	$(UV) sync

# -------------------------
# Generate (no explicit venv activation)
# -------------------------
generate: install
	@echo "Running generator script..."
	$(UV) run python scripts/generate.py

# -------------------------
# Safety Check
# -------------------------
check-dirs:
ifeq ($(OS),Windows_NT)
	@if "$(INPUT_DIR)"=="\" (echo Refusing to operate on root & exit 1)
	@if "$(OUTPUT_DIR)"=="\" (echo Refusing to operate on root & exit 1)
else
	@if [ "$(INPUT_DIR)" = "/" ] || [ "$(OUTPUT_DIR)" = "/" ]; then \
		echo "Refusing to operate on root directory"; exit 1; \
	fi
endif

# -------------------------
# Cleanup (Hardened)
# -------------------------
cleanup: check-dirs
	@echo "Cleaning input files and output directories..."
	$(UV) run python - <<'EOF'
	import os
	import shutil
	from pathlib import Path

	INPUT_DIR = Path("input_files")
	OUTPUT_DIR = Path("output_files")

	# Prevent accidental deletion of root
	for d in (INPUT_DIR, OUTPUT_DIR):
		if d.resolve() in (Path("/").resolve(), Path("C:/").resolve()):
			raise RuntimeError(f"Refusing to operate on {d}")

	# Delete .txt files in input_files
	for f in INPUT_DIR.glob("*.txt"):
		f.unlink()
		print(f"Deleted file:", f.name)

	# Delete all subdirectories in output_files
	for d in OUTPUT_DIR.iterdir():
		if d.is_dir():
			shutil.rmtree(d)
			print(f"Deleted folder:", d.name)
	EOF
		@echo "Cleanup complete."

# -------------------------
# Reset Environment
# -------------------------
reset:
	@echo "Resetting environment..."
	$(UV) venv --clear
	$(MAKE) install

# -------------------------
# Pre-commit Hooks
# -------------------------
precommit: install
	@echo "Installing pre-commit Git hooks..."
	$(UV) run pre-commit install

precommit-check:
	@echo "Running pre-commit hooks on all files..."
	$(UV) run pre-commit run --all-files
